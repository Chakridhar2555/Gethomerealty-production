"use strict";(()=>{var e={};e.id=8234,e.ids=[8234],e.modules={38013:e=>{e.exports=require("mongodb")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},46406:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>f,originalPathname:()=>I,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>v});var o={};t.r(o),t.d(o,{POST:()=>p});var s=t(95419),a=t(69108),i=t(99678),n=t(78070),l=t(22345),c=t(38013),u=t(18378),d=t.n(u);async function p(e){try{let r=d()(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN),{leadId:t,phoneNumber:o}=await e.json(),s=process.env.NEXT_PUBLIC_APP_URL;if(!s)throw Error("NEXT_PUBLIC_APP_URL is not configured");if(!process.env.TWILIO_PHONE_NUMBER)throw Error("TWILIO_PHONE_NUMBER is not configured");let a=o.replace(/[^0-9+]/g,""),i="";if(a.startsWith("+"))i=a;else if(a.startsWith("91")&&12===a.length)i="+"+a;else if(10===a.length)i="+91"+a;else throw console.error("Invalid phone number format:",{original:o,cleaned:a,length:a.length}),Error("Invalid phone number format. Please check the number and try again.");console.log("Formatted number:",{original:o,cleaned:a,e164:i}),console.log("Initiating call with:",{to:i,from:process.env.TWILIO_PHONE_NUMBER,baseUrl:s});try{let e=await r.calls.create({twiml:`<?xml version="1.0" encoding="UTF-8"?>
          <Response>
            <Say>Hello, would you like to know more about this property? Please wait while we connect you with our agent.</Say>
            <Dial callerId="${process.env.TWILIO_PHONE_NUMBER}" record="record-from-answer">${i}</Dial>
          </Response>`,to:i,from:process.env.TWILIO_PHONE_NUMBER,record:!0,statusCallback:`${s}/api/twilio/webhook`,statusCallbackEvent:["completed"],statusCallbackMethod:"POST"});console.log("Call initiated:",e.sid);let o={date:new Date,duration:0,recording:null,twilioCallSid:e.sid,status:"initiated"},{db:a}=await (0,l.v)(),u=await a.collection("leads").findOneAndUpdate({_id:new c.ObjectId(t)},{$push:{callHistory:o}},{returnDocument:"after"});if(!u?.value)return n.Z.json({error:"Lead not found"},{status:404});return n.Z.json({success:!0,call:e,lead:u.value})}catch(e){if(console.error("Twilio error:",{code:e.code,message:e.message,details:e.details}),21219===e.code)return n.Z.json({error:"This number needs to be verified in your Twilio account first.",code:"UNVERIFIED_NUMBER"},{status:400});return n.Z.json({error:"Twilio error",details:e.message,code:e.code},{status:400})}}catch(e){return console.error("Call error:",e),n.Z.json({error:"Failed to initiate call",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/call/route",pathname:"/api/call",filename:"route",bundlePath:"app/api/call/route"},resolvedPagePath:"/Users/chakrinaidu/Desktop/Gethomerealty-production/app/api/call/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:w,headerHooks:f,staticGenerationBailout:v}=h,I="/api/call/route";function x(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},22345:(e,r,t)=>{let o;t.d(r,{v:()=>i});var s=t(38013);if(!process.env.MONGODB_URI)throw Error("Please add your Mongo URI to .env.local");let a=process.env.MONGODB_URI;async function i(){try{let e=await o;return{db:e.db(),client:e}}catch(e){throw console.error("MongoDB connection error:",e),e}}o=new s.MongoClient(a,{connectTimeoutMS:1e4,socketTimeoutMS:45e3,serverSelectionTimeoutMS:5e3,maxPoolSize:10,retryWrites:!0,retryReads:!0}).connect()}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,1185,8378],()=>t(46406));module.exports=o})();